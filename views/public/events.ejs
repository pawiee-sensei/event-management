<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Community Events Feed</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f1f5f9;
      margin: 0;
      color: #1e293b;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 25px 40px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 { margin: 0; font-size: 28px; }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      background: #fff;
      padding: 15px 25px;
      margin: 25px auto;
      max-width: 900px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .filter-bar input, .filter-bar select {
      padding: 10px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 15px;
      width: 250px;
      outline: none;
    }

    .filter-bar button {
      padding: 10px 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .filter-bar button:hover { background: #1d4ed8; }

    /* Feed Layout */
    .feed {
      max-width: 850px;
      margin: 0 auto 60px;
      display: flex;
      flex-direction: column;
      gap: 35px;
      padding: 0 20px;
    }

    .post {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .post-header { padding: 18px 22px; border-bottom: 1px solid #e5e7eb; }
    .post-header h2 { margin: 0; font-size: 22px; }
    .post-header p { margin: 6px 0 0; color: #64748b; font-size: 14px; }
    .post img { width: 100%; max-height: 360px; object-fit: cover; cursor: pointer; }
    .post-content { padding: 20px; line-height: 1.6; }

    .open-comments-btn {
      background: none;
      border: none;
      color: #2563eb;
      font-size: 15px;
      cursor: pointer;
      margin: 0 0 20px 22px;
    }

    .open-comments-btn:hover { text-decoration: underline; }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal.active { opacity: 1; pointer-events: auto; }

    .modal-dialog {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 650px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }

    .close-btn { background: none; border: none; font-size: 22px; cursor: pointer; }

    /* Comments */
    .comment-thread {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 10px;
    }

    .comment-item {
      display: flex;
      gap: 12px;
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      transition: background 0.2s ease;
    }

    .comment-item:hover { background: #f1f5f9; }

    .comment-item img {
      border-radius: 50%;
      width: 36px;
      height: 36px;
    }

    .comment-content { flex: 1; }

    .comment-content strong {
      font-size: 15px;
      color: #111827;
    }

    .comment-content p {
      margin: 4px 0;
      color: #334155;
    }

    .comment-content small {
      display: inline-block;
      color: #94a3b8;
      font-size: 12px;
    }

    .comment-actions { margin-top: 4px; }

    .reply-btn, .view-replies-btn {
      background: none;
      border: none;
      color: #2563eb;
      font-size: 13px;
      cursor: pointer;
      margin-right: 10px;
    }

    .reply-btn:hover, .view-replies-btn:hover { text-decoration: underline; }

    .reply-thread {
      margin-left: 45px;
      padding-left: 12px;
      border-left: 2px solid #e2e8f0;
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .reply-thread.active { display: flex; }

    .reply {
      background: #fff;
      border: 1px solid #e2e8f0;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .comment-form {
      margin-top: 20px;
      border-top: 1px solid #e2e8f0;
      padding-top: 15px;
    }

    .comment-form input, .comment-form textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .comment-form button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      float: right;
    }

    .comment-form button:hover { background: #1d4ed8; }

    footer { text-align: center; padding: 20px; background: #f1f5f9; color: #64748b; }
  </style>
</head>
<body>
  <header><h1>Discover & Discuss Events</h1></header>

  <!-- SEARCH & FILTER -->
  <form class="filter-bar" method="GET" action="/events">
    <input type="text" name="search" value="<%= search || '' %>" placeholder="Search events...">
    <select name="category">
      <option value="">All Categories</option>
      <option value="Food" <%= category==='Food'?'selected':'' %>>Food</option>
      <option value="Music" <%= category==='Music'?'selected':'' %>>Music</option>
      <option value="Sports" <%= category==='Sports'?'selected':'' %>>Sports</option>
      <option value="Technology" <%= category==='Technology'?'selected':'' %>>Technology</option>
      <option value="Community" <%= category==='Community'?'selected':'' %>>Community</option>
      <option value="Education" <%= category==='Education'?'selected':'' %>>Education</option>
    </select>
    <button type="submit">Filter</button>
  </form>

  <div class="feed">
    <% if (events.length === 0) { %>
      <p style="text-align:center;">No approved events found.</p>
    <% } else { events.forEach(event => { %>
      <div class="post">
        <div class="post-header">
          <h2><%= event.title %></h2>
          <p>By <%= event.organizer_name || 'Unknown' %> â€¢ <%= new Date(event.date).toDateString() %></p>
        </div>
        <% if (event.image) { %>
          <img src="/uploads/banners/<%= event.image %>" alt="<%= event.title %>" data-event-id="<%= event.id %>">
        <% } %>
        <div class="post-content">
          <p><%= event.description %></p>
          <p><strong>Location:</strong> <%= event.location %></p>
          <p><strong>Category:</strong> <%= event.category || 'N/A' %></p>
        </div>
        <button class="open-comments-btn" data-event="<%= event.id %>">
          ðŸ’¬ View Comments (<%= event.commentCount || 0 %>)
        </button>
      </div>
    <% }) } %>
  </div>

  <!-- COMMENTS MODAL -->
  <div id="commentsModal" class="modal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 id="commentsTitle">Comments</h3>
        <button class="close-btn" onclick="closeCommentsModal()">&times;</button>
      </div>
      <div id="commentsContent" style="max-height:70vh; overflow-y:auto;"></div>
    </div>
  </div>

  <footer>Â© <%= new Date().getFullYear() %> Event Management System</footer>

<script>
  const commentsModal = document.getElementById('commentsModal');
  const commentsContent = document.getElementById('commentsContent');
  const commentsTitle = document.getElementById('commentsTitle');
  let currentEventId = null;

  document.querySelectorAll('.open-comments-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      currentEventId = btn.dataset.event;
      const title = btn.closest('.post').querySelector('h2').textContent;
      await openCommentsModal(currentEventId, title);
    });
  });

  function closeCommentsModal() {
    commentsModal.classList.remove('active');
  }

  commentsModal.addEventListener('click', e => {
    if (e.target === commentsModal) closeCommentsModal();
  });

  async function openCommentsModal(eventId, title) {
    commentsTitle.textContent = title;
    const res = await fetch(`/comments/${eventId}`);
    const comments = await res.json();
    renderComments(comments);
    commentsModal.classList.add('active');
  }

  function renderComments(comments) {
    const mainComments = comments.filter(c => !c.parent_id);
    const html = mainComments.map(c => renderComment(c, comments)).join('');
    commentsContent.innerHTML = `
      <div class="comment-thread">${html || '<p>No comments yet.</p>'}</div>
      <form class="comment-form" id="commentForm">
        <input type="hidden" name="parent_id" value="">
        <input type="text" name="user_name" placeholder="Your name" required>
        <textarea name="comment" placeholder="Write a comment..." required></textarea>
        <button type="submit">Post</button>
      </form>
    `;
  }

  function renderComment(comment, all) {
    const replies = all.filter(r => r.parent_id === comment.id);
    return `
      <div class="comment-item">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="user">
        <div class="comment-content">
          <strong>${escapeHTML(comment.user_name)}</strong>
          <p>${escapeHTML(comment.comment)}</p>
          <small>${new Date(comment.created_at).toLocaleString()}</small>
          <div class="comment-actions">
            <button class="reply-btn" data-id="${comment.id}">Reply</button>
            ${replies.length > 0 ? 
              `<button class="view-replies-btn" data-id="${comment.id}">View ${replies.length} repl${replies.length > 1 ? 'ies' : 'y'}</button>` 
              : ''}
          </div>
          <div class="reply-thread" id="replies-${comment.id}">
            ${replies.map(r => `
              <div class="comment-item reply">
                <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="user">
                <div class="comment-content">
                  <strong>${escapeHTML(r.user_name)}</strong>
                  <p>${escapeHTML(r.comment)}</p>
                  <small>${new Date(r.created_at).toLocaleString()}</small>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  commentsContent.addEventListener('submit', async e => {
    if (e.target.id !== 'commentForm') return;
    e.preventDefault();
    const form = e.target;
    const data = {
      user_name: form.user_name.value.trim(),
      comment: form.comment.value.trim(),
      parent_id: form.parent_id.value || null
    };

    if (!data.user_name || !data.comment) return alert("Please fill all fields");

    await fetch(`/comments/${currentEventId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const updated = await (await fetch(`/comments/${currentEventId}`)).json();
    renderComments(updated);
  });

  commentsContent.addEventListener('click', e => {
    if (e.target.classList.contains('reply-btn')) {
      const id = e.target.dataset.id;
      const form = document.getElementById('commentForm');
      form.parent_id.value = id;
      form.scrollIntoView({ behavior: 'smooth', block: 'center' });
      form.comment.placeholder = 'Replying...';
      form.comment.focus();
    }

    if (e.target.classList.contains('view-replies-btn')) {
      const thread = document.getElementById(`replies-${e.target.dataset.id}`);
      const isOpen = thread.classList.toggle('active');
      e.target.textContent = isOpen ? 'Hide replies' : e.target.textContent.replace('Hide', 'View');
    }
  });

  function escapeHTML(s) {
    return String(s).replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  }
</script>
</body>
</html>
