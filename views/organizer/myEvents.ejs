<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Events</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f9fafb;
      color: #1e293b;
      padding: 30px;
    }

    h1 { margin-bottom: 10px; }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    a.btn {
      background: #2563eb;
      color: white;
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 8px;
      transition: background 0.2s ease;
    }
    a.btn:hover { background: #1d4ed8; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
      margin-top: 20px;
    }

    th, td {
      padding: 14px 16px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #f1f5f9;
      font-weight: 600;
    }

    tr.event-row {
      cursor: pointer;
      transition: background 0.2s ease;
    }
    tr.event-row:hover { background: #f9fafb; }

    /* Collapse */
    .event-details {
      height: 0;
      overflow: hidden;
      background: #f8fafc;
      border-top: 1px solid #e5e7eb;
      transition: height 0.35s ease, opacity 0.3s ease;
      opacity: 0;
    }
    .event-details.active { opacity: 1; height: auto; }

    .details-frame {
      display: flex;
      align-items: flex-start;
      gap: 25px;
      padding: 25px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      background: white;
      margin: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .details-text { flex: 2; line-height: 1.6; }
    .details-image { flex: 1; text-align: center; }
    .details-image img {
      width: 100%; max-width: 480px;
      border-radius: 8px; border: 2px solid #e5e7eb;
      transition: transform 0.3s ease;
    }
    .details-image img:hover { transform: scale(1.05); }

    .approved { color: #16a34a; font-weight: 600; }
    .pending { color: #ca8a04; font-weight: 600; }
    .rejected { color: #dc2626; font-weight: 600; }

    .reject-note {
      margin-top: 8px;
      font-size: 0.9em;
      color: #991b1b;
      background: #fff5f5;
      border-left: 4px solid #dc2626;
      padding: 8px 10px;
      border-radius: 6px;
      line-height: 1.4;
    }

    .comments-section {
      margin-top: 20px;
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .comment {
      background: white;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-bottom: 10px;
    }

    .comment strong { color: #1e293b; }
    .comment p { margin: 5px 0; color: #334155; }
    .comment small { color: #64748b; }
    .comment form { display: inline; }

    .reply-block {
      margin-left: 25px;
      border-left: 2px solid #e2e8f0;
      padding-left: 12px;
      margin-top: 6px;
    }

    .btn-sm {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-sm.red { background: #dc2626; }
    .btn-sm:hover { opacity: 0.9; }

    .no-events {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>My Events</h1>
    <div>
      <a class="btn" href="/organizer/dashboard">‚Üê Dashboard</a>
      <a class="btn" href="/organizer/events/new">+ New Event</a>
      <a class="btn" href="/organizer/logout" style="background:#dc2626;">Logout</a>
    </div>
  </div>

  <% if (events.length === 0) { %>
    <div class="no-events">
      <p>No events yet. Create one to get started!</p>
    </div>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Category</th>
          <th>Status</th>
          <th>Comments</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% events.forEach(ev => { %>
          <tr class="event-row" data-event-id="<%= ev.id %>">
            <td><%= ev.title %></td>
            <td><%= ev.date %></td>
            <td><%= ev.category || '‚Äî' %></td>
            <td>
              <% if (ev.status === 'pending') { %>
                <span class="pending">Pending</span>
              <% } else if (ev.status === 'approved') { %>
                <span class="approved">Approved</span>
              <% } else { %>
                <span class="rejected">Rejected</span>
              <% } %>
            </td>
            <td><%= ev.comment_count || 0 %></td>
            <td>
              <a href="/organizer/events/<%= ev.id %>/edit" class="btn-sm">Edit</a>
              <form method="POST" action="/organizer/events/<%= ev.id %>/delete" onsubmit="return confirm('Delete this event?')" style="display:inline;">
                <button class="btn-sm red" type="submit">Delete</button>
              </form>
            </td>
          </tr>

          <tr>
            <td colspan="6">
              <div class="event-details" id="details-<%= ev.id %>">
                <div class="details-frame">
                  <div class="details-text">
                    <p><strong>Description:</strong> <%= ev.description %></p>
                    <p><strong>Location:</strong> <%= ev.location %></p>
                    <p><strong>Date & Time:</strong> <%= ev.date %> at <%= ev.time %></p>
                    <p><strong>Category:</strong> <%= ev.category || 'N/A' %></p>
                    <% if (ev.proof) { %>
                      <p><strong>Proof:</strong> <a href="/uploads/proofs/<%= ev.proof %>" target="_blank">View Proof</a></p>
                    <% } %>

                    <% if (ev.status === 'rejected' && ev.rejection_reason) { %>
                      <div class="reject-note"><p><strong>Reason:</strong> <%= ev.rejection_reason %></p></div>
                    <% } %>

                    <% if (ev.status === 'approved') { %>
                      <div class="comments-section">
                        <h3>üí¨ Comments (<%= ev.comment_count %>)</h3>
                        <% if (ev.comments.length === 0) { %>
                          <p style="color:#64748b;">No comments yet.</p>
                        <% } else { %>
                          <% ev.comments.forEach(c => { %>
                            <div class="comment">
                              <strong><%= c.user_name %></strong>
                              <p><%= c.comment %></p>
                              <small><%= new Date(c.created_at).toLocaleString() %></small>
                              <form method="POST" action="/organizer/comments/<%= c.id %>/delete" onsubmit="return confirm('Delete this comment and its replies?')">
                                <button type="submit" class="btn-sm red">Delete</button>
                              </form>

                              <% if (c.replies && c.replies.length > 0) { %>
                                <div class="reply-block">
                                  <% c.replies.forEach(r => { %>
                                    <div class="comment reply">
                                      <strong>‚Ü≥ <%= r.user_name %></strong>
                                      <p><%= r.comment %></p>
                                      <small><%= new Date(r.created_at).toLocaleString() %></small>
                                      <form method="POST" action="/organizer/comments/<%= r.id %>/delete" onsubmit="return confirm('Delete this reply?')">
                                        <button type="submit" class="btn-sm red">Delete</button>
                                      </form>
                                    </div>
                                  <% }) %>
                                </div>
                              <% } %>
                            </div>
                          <% }) %>
                        <% } %>
                      </div>
                    <% } %>
                  </div>

                  <div class="details-image">
                    <% if (ev.image) { %>
                      <img src="/uploads/banners/<%= ev.image %>" alt="Event Banner">
                    <% } else { %>
                      <img src="https://via.placeholder.com/400x220?text=No+Banner" alt="No Banner">
                    <% } %>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>

  <script>
    // Smooth expand/collapse logic
    const rows = document.querySelectorAll('.event-row');
    rows.forEach(row => {
      row.addEventListener('click', e => {
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('form')) return;
        const id = row.dataset.eventId;
        const details = document.getElementById(`details-${id}`);
        const active = details.classList.contains('active');

        document.querySelectorAll('.event-details').forEach(d => {
          d.classList.remove('active');
          d.style.height = '0';
        });

        if (!active) {
          details.classList.add('active');
          details.style.height = details.scrollHeight + 'px';
        }
      });
    });
  </script>
</body>
</html>
